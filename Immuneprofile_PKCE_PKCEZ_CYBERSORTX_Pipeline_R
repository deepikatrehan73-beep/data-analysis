# Pipeline: Immune Cell Deconvolution using CIBERSORT-X
# Author: Deepika Trehan
# Description: This script processes normalized bladder cancer expression data 
#              to estimate the abundance of 22 infiltrating immune cell subsets.

# 1. Load Required Libraries
library(ggplot2)
library(reshape2)
library(pheatmap)

# 2. Prepare Input Data
# CIBERSORT-X requires a non-log linear space mixture file.
# Note: Input data should be the normalized count matrix from the DESeq2 pipeline.
exp_matrix <- read.csv("TCGA_BLCA_Normalized_Counts.csv", row.names = 1)

# 3. CIBERSORT-X Deconvolution Logic
# Traditionally, CIBERSORT-X is run via their web portal or Docker container.
# This section processes the results (CIBERSORT-X_Results.csv) for visualization.
results <- read.csv("CIBERSORT-X_Results.csv", row.names = 1)

# 4. Visualization: Stacked Barplot of Immune Fractions
# Reflects the 'Immune Cell Fractions' analysis in Trehan et al. (2023)
results_long <- melt(as.matrix(results[, 1:22]))
colnames(results_long) <- c("Sample", "CellType", "Abundance")

ggplot(results_long, aes(x = Sample, y = Abundance, fill = CellType)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    labs(title = "Immune Cell Fractions in Bladder Cancer",
         x = "Samples (Control vs. siRNA Treated)",
         y = "Estimated Fraction") +
    theme(axis.text.x = element_text(angle = 90))

# 5. Visualization: Immune Infiltration Heatmap
# Reflects the hierarchical clustering of macrophage (M0/M1) and B-cell shifts
pheatmap(t(results[, 1:22]), 
         clustering_distance_rows = "correlation",
         main = "Immune Cell Infiltration Heatmap (Z-score)",
         color = colorRampPalette(c("blue", "white", "red"))(100),
         scale = "row")

# 6. Functional Summary
# In my work, this pipeline identified that PRKC epsilon & zeta knockdown reduces M0/M1 macrophage lineages and enriches for Dendritic cells[cite: 2056, 2175].
